<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoices â€” Register-Call</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:       #0f0c07;
      --surface:  #1a1510;
      --panel:    #221e16;
      --border:   #3a3325;
      --gold:     #b8860b;
      --gold-lt:  #d4a017;
      --text:     #f0e8d0;
      --muted:    #8a7e68;
      --green:    #22863a;
      --blue:     #0075ca;
      --red:      #cb2431;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: Georgia, 'Times New Roman', serif;
      min-height: 100vh;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .app { display: flex; flex-direction: column; min-height: 100vh; }
    .masthead {
      background: var(--surface);
      border-bottom: 3px solid var(--gold);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .masthead-logo {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--gold);
      letter-spacing: 0.02em;
    }
    .masthead-sub {
      font-size: 0.78rem;
      color: var(--muted);
      font-style: italic;
    }
    .masthead-right { margin-left: auto; display: flex; gap: 10px; align-items: center; }

    .main { display: flex; flex: 1; overflow: hidden; height: calc(100vh - 63px); }

    /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      width: 200px;
      flex-shrink: 0;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 16px 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .sidebar-label {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 8px 16px 4px;
    }
    .sidebar-item {
      padding: 9px 16px;
      font-size: 0.88rem;
      cursor: pointer;
      color: var(--muted);
      border-left: 3px solid transparent;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-item:hover { background: var(--panel); color: var(--text); }
    .sidebar-item.active { color: var(--gold); border-left-color: var(--gold); background: var(--panel); }
    .badge {
      font-size: 0.72rem;
      background: var(--border);
      color: var(--muted);
      border-radius: 10px;
      padding: 1px 7px;
      font-family: sans-serif;
    }

    /* â”€â”€ Content area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .content { flex: 1; overflow-y: auto; padding: 20px 24px; }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .search-input {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: sans-serif;
      font-size: 0.88rem;
      padding: 7px 12px;
      border-radius: 6px;
      flex: 1;
      max-width: 300px;
    }
    .search-input:focus { outline: none; border-color: var(--gold); }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    button {
      font-family: Georgia, serif;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      font-size: 0.85rem;
      padding: 7px 14px;
    }
    .btn-primary { background: var(--gold); color: #fff; font-weight: bold; }
    .btn-primary:hover { background: var(--gold-lt); }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--muted); }
    .btn-ghost:hover { border-color: var(--gold); color: var(--gold); }
    .btn-sm { padding: 4px 10px; font-size: 0.78rem; }
    .btn-danger { background: #3b1a1a; color: #f47; border: 1px solid #5a2020; }

    /* â”€â”€ Invoice table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .invoice-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .invoice-table th {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 2px solid var(--gold);
      color: var(--muted);
      font-weight: normal;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      white-space: nowrap;
    }
    .invoice-table td { padding: 9px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .invoice-table tr:hover td { background: var(--panel); }
    .client-name { font-weight: bold; color: var(--text); }
    .client-email { font-size: 0.78rem; color: var(--muted); }
    .amount { font-variant-numeric: tabular-nums; }
    .empty-row td { text-align: center; padding: 40px; color: var(--muted); font-style: italic; }

    /* â”€â”€ Status badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-badge {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 10px;
      font-size: 0.74rem;
      font-family: sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .status-draft { background: #2a2820; color: #a09070; border: 1px solid #4a4030; }
    .status-sent  { background: #0a1f3a; color: #5b9bd5; border: 1px solid #1a4070; }
    .status-paid  { background: #0a2a14; color: #4caf70; border: 1px solid #1a5030; }

    /* â”€â”€ Drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .drawer-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
    }
    .drawer {
      position: fixed; top: 0; right: 0; width: 480px; height: 100%;
      background: var(--panel); border-left: 1px solid var(--border);
      box-shadow: -6px 0 30px rgba(0,0,0,0.5);
      z-index: 101; overflow-y: auto; padding: 24px;
    }
    .drawer h2 { color: var(--gold); font-size: 1.1rem; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

    /* â”€â”€ Form fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-full { grid-column: 1 / -1; }
    label { display: block; font-size: 0.78rem; color: var(--muted); margin-bottom: 4px; }
    input[type="text"], input[type="email"], input[type="date"], input[type="number"],
    select, textarea {
      width: 100%; background: var(--surface); border: 1px solid var(--border);
      color: var(--text); font-family: Georgia, serif; font-size: 0.88rem;
      padding: 8px 10px; border-radius: 5px;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--gold); }
    textarea { resize: vertical; min-height: 70px; }

    /* â”€â”€ Date picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .date-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;
      margin-top: 4px;
    }
    .date-chip {
      padding: 6px 4px; font-size: 0.78rem; font-family: sans-serif;
      text-align: center; border: 1px solid var(--border); border-radius: 4px;
      cursor: pointer; color: var(--muted); background: var(--surface);
      transition: all 0.12s;
    }
    .date-chip:hover { border-color: var(--gold); color: var(--gold-lt); }
    .date-chip.selected { background: var(--gold); border-color: var(--gold); color: #fff; font-weight: bold; }

    /* â”€â”€ Total box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .total-box {
      background: var(--surface); border: 1px solid var(--gold);
      border-radius: 6px; padding: 14px 16px; margin-top: 16px;
    }
    .total-row { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 3px 0; color: var(--muted); }
    .total-final { font-size: 1.2rem; font-weight: bold; color: var(--gold); border-top: 1px solid var(--border); padding-top: 8px; margin-top: 6px; }

    .drawer-actions { display: flex; gap: 10px; margin-top: 20px; }

    .msg-bar {
      background: var(--panel); border-left: 3px solid var(--gold);
      padding: 8px 14px; font-size: 0.85rem; margin-bottom: 14px;
      border-radius: 0 5px 5px 0; color: var(--gold-lt);
    }

    .action-row { display: flex; gap: 6px; flex-wrap: wrap; }
    .spinner { animation: spin 0.8s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useCallback } = React;

// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = "/api/v1";

const PUBLICATIONS = ["Register-Call", "The Villager"];
const AD_TYPES = ["Classified Ad", "Legal Notice"];
const FIRST_LINE_RATE      = 0.43;
const ADDITIONAL_LINE_RATE = 0.38;
const ORIGINATION_FEE      = 25.00;

function getNextThursdays(count = 14) {
  const dates = [];
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  const dayOfWeek = d.getDay();
  const daysUntil = ((4 - dayOfWeek) + 7) % 7 || 7;
  d.setDate(d.getDate() + daysUntil);
  for (let i = 0; i < count; i++) {
    dates.push(d.toISOString().slice(0, 10));
    d.setDate(d.getDate() + 7);
  }
  return dates;
}

function calcAmount(lineCount, runs, firstRate, addRate, origFee) {
  const lc = Math.max(1, parseInt(lineCount) || 1);
  const r  = Math.max(0, parseInt(runs) || 0);
  const fr = parseFloat(firstRate) || 0;
  const ar = parseFloat(addRate) || 0;
  const of = parseFloat(origFee) || 0;
  return (of + r * fr + r * Math.max(0, lc - 1) * ar).toFixed(2);
}

function fmt$(v) { return `$${parseFloat(v || 0).toFixed(2)}`; }
function fmtDate(iso) {
  if (!iso) return "â€”";
  const [y, m, d] = iso.split("-");
  return `${m}/${d}/${y}`;
}
function parseRunDates(raw) {
  if (Array.isArray(raw)) return raw;
  try { return JSON.parse(raw || "[]"); } catch { return []; }
}

// â”€â”€ Status badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function StatusBadge({ status }) {
  return <span className={`status-badge status-${status}`}>{status}</span>;
}

// â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Sidebar({ filter, setFilter, counts, onNew }) {
  const tabs = [
    { key: "all",   label: "All Invoices" },
    { key: "draft", label: "Drafts" },
    { key: "sent",  label: "Sent" },
    { key: "paid",  label: "Paid" },
  ];
  return (
    <div className="sidebar">
      <div className="sidebar-label">Filter</div>
      {tabs.map(t => (
        <div key={t.key}
          className={`sidebar-item ${filter === t.key ? "active" : ""}`}
          onClick={() => setFilter(t.key)}>
          {t.label}
          <span className="badge">{counts[t.key] ?? 0}</span>
        </div>
      ))}
      <div style={{ flex: 1 }} />
      <div style={{ padding: "16px" }}>
        <button className="btn-primary" style={{ width: "100%" }} onClick={onNew}>
          + New Invoice
        </button>
      </div>
    </div>
  );
}

// â”€â”€ Date picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DatePicker({ selected, onChange }) {
  const available = getNextThursdays(14);
  const toggle = (d) => {
    const next = selected.includes(d)
      ? selected.filter(x => x !== d)
      : [...selected, d].sort();
    onChange(next);
  };
  return (
    <div className="date-grid">
      {available.map(d => (
        <div key={d}
          className={`date-chip ${selected.includes(d) ? "selected" : ""}`}
          onClick={() => toggle(d)}>
          {fmtDate(d)}
        </div>
      ))}
    </div>
  );
}

// â”€â”€ Total box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TotalBox({ lineCount, runs, firstRate, addRate, origFee }) {
  const lc   = Math.max(1, parseInt(lineCount) || 1);
  const r    = parseInt(runs) || 0;
  const fr   = parseFloat(firstRate) || 0;
  const ar   = parseFloat(addRate) || 0;
  const of   = parseFloat(origFee) || 0;
  const firstLines  = r * fr;
  const addLines    = r * Math.max(0, lc - 1) * ar;
  const total       = (of + firstLines + addLines).toFixed(2);
  return (
    <div className="total-box">
      <div className="total-row"><span>Origination fee</span><span>{fmt$(of)}</span></div>
      <div className="total-row"><span>1st line Ã— {r} run{r !== 1 ? "s" : ""} @ {fmt$(fr)}</span><span>{fmt$(firstLines)}</span></div>
      {lc > 1 && (
        <div className="total-row">
          <span>+{lc - 1} add. line{lc > 2 ? "s" : ""} Ã— {r} run{r !== 1 ? "s" : ""} @ {fmt$(ar)}</span>
          <span>{fmt$(addLines)}</span>
        </div>
      )}
      <div className="total-row total-final"><span>TOTAL DUE</span><span>{fmt$(total)}</span></div>
    </div>
  );
}

// â”€â”€ Invoice form drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function InvoiceDrawer({ inv, onSave, onClose }) {
  const editing = !!inv;
  const today = new Date().toISOString().slice(0, 10);

  const [form, setForm] = useState({
    date:               inv?.date        || today,
    client:             inv?.client      || "",
    email:              inv?.email       || "",
    type:               inv?.type        || "Classified Ad",
    publication:        inv?.publication || "Register-Call",
    description:        inv?.description || "",
    lineCount:          inv?.lineCount   || 1,
    firstLineRate:      inv?.firstLineRate      || FIRST_LINE_RATE,
    additionalLineRate: inv?.additionalLineRate  || ADDITIONAL_LINE_RATE,
    originationFee:     inv?.originationFee     || ORIGINATION_FEE,
    isArapahoeCounty:   inv?.isArapahoeCounty   || false,
    notes:              inv?.notes       || "",
  });
  const [runDates, setRunDates] = useState(parseRunDates(inv?.runDates));
  const [saving, setSaving] = useState(false);
  const [err, setErr] = useState("");

  const set = (k, v) => setForm(f => ({ ...f, [k]: v }));

  const submit = async () => {
    if (!form.client.trim()) { setErr("Client name is required."); return; }
    setSaving(true);
    setErr("");
    const payload = {
      ...form,
      lineCount:  parseInt(form.lineCount),
      runs:       runDates.length,
      runDates,
      amount: parseFloat(calcAmount(form.lineCount, runDates.length, form.firstLineRate, form.additionalLineRate, form.originationFee)),
    };
    try {
      let res;
      if (editing) {
        res = await fetch(`${API}/billing/invoices/${inv.id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      } else {
        res = await fetch(`${API}/billing/invoices`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      onSave(data);
    } catch (e) {
      setErr(e.message);
    } finally {
      setSaving(false);
    }
  };

  return (
    <>
      <div className="drawer-overlay" onClick={onClose} />
      <div className="drawer">
        <h2>{editing ? `Edit Invoice â€” ${inv.client}` : "New Invoice"}</h2>
        {err && <div className="msg-bar" style={{ borderColor: "#cb2431", color: "#f47" }}>{err}</div>}
        <div className="form-grid">
          <div className="form-full">
            <label>Client Name *</label>
            <input type="text" value={form.client} onChange={e => set("client", e.target.value)} />
          </div>
          <div className="form-full">
            <label>Client Email</label>
            <input type="email" value={form.email} onChange={e => set("email", e.target.value)} />
          </div>
          <div>
            <label>Publication</label>
            <select value={form.publication} onChange={e => set("publication", e.target.value)}>
              {PUBLICATIONS.map(p => <option key={p}>{p}</option>)}
            </select>
          </div>
          <div>
            <label>Ad Type</label>
            <select value={form.type} onChange={e => set("type", e.target.value)}>
              {AD_TYPES.map(t => <option key={t}>{t}</option>)}
            </select>
          </div>
          <div>
            <label>Invoice Date</label>
            <input type="date" value={form.date} onChange={e => set("date", e.target.value)} />
          </div>
          <div>
            <label>Number of Lines</label>
            <input type="number" min="1" max="99" value={form.lineCount}
              onChange={e => set("lineCount", e.target.value)} />
          </div>
          <div className="form-full">
            <label>Ad Description / Content</label>
            <textarea value={form.description} onChange={e => set("description", e.target.value)} rows={3} />
          </div>
          <div className="form-full">
            <label>Run Dates ({runDates.length} selected â†’ {runDates.length} run{runDates.length !== 1 ? "s" : ""})</label>
            <DatePicker selected={runDates} onChange={setRunDates} />
          </div>

          {/* Rates */}
          <div>
            <label>1st Line Rate ($/run)</label>
            <input type="number" step="0.01" value={form.firstLineRate}
              onChange={e => set("firstLineRate", e.target.value)} />
          </div>
          <div>
            <label>Add. Lines Rate ($/run)</label>
            <input type="number" step="0.01" value={form.additionalLineRate}
              onChange={e => set("additionalLineRate", e.target.value)} />
          </div>
          <div>
            <label>Origination Fee ($)</label>
            <input type="number" step="0.01" value={form.originationFee}
              onChange={e => set("originationFee", e.target.value)} />
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 8, paddingTop: 20 }}>
            <input type="checkbox" id="arapahoe" checked={form.isArapahoeCounty}
              onChange={e => set("isArapahoeCounty", e.target.checked)} />
            <label htmlFor="arapahoe" style={{ margin: 0 }}>Arapahoe County</label>
          </div>
          <div className="form-full">
            <label>Internal Notes</label>
            <textarea value={form.notes} onChange={e => set("notes", e.target.value)} rows={2} />
          </div>
        </div>

        <TotalBox
          lineCount={form.lineCount}
          runs={runDates.length}
          firstRate={form.firstLineRate}
          addRate={form.additionalLineRate}
          origFee={form.originationFee}
        />

        <div className="drawer-actions">
          <button className="btn-primary" onClick={submit} disabled={saving}>
            {saving ? <span className="spinner">âŸ³</span> : (editing ? "Save Changes" : "Create Invoice")}
          </button>
          <button className="btn-ghost" onClick={onClose}>Cancel</button>
        </div>
      </div>
    </>
  );
}

// â”€â”€ Invoice row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function InvoiceRow({ inv, onEdit, onRefresh, onMsg }) {
  const [busy, setBusy] = useState(null);
  const runDates = parseRunDates(inv.runDates);

  const action = async (label, fn) => {
    setBusy(label);
    try { await fn(); } catch (e) { onMsg(`Error: ${e.message}`); }
    finally { setBusy(null); onRefresh(); }
  };

  const sendEmail = () => action("email", async () => {
    const r = await fetch(`${API}/billing/email/send`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ invoice_id: inv.id }),
    });
    const d = await r.json();
    onMsg(d.sent ? `Email sent to ${inv.email}` : `Email not sent: ${d.reason || d.error}`);
  });

  const getStripeLink = () => action("stripe", async () => {
    const r = await fetch(`${API}/billing/stripe/link`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ invoice_id: inv.id }),
    });
    const d = await r.json();
    if (d.link) { window.open(d.link, "_blank"); onMsg(`Stripe link ready${d.stub ? " (stub)" : ""}`); }
    else onMsg(`Stripe error: ${d.error}`);
  });

  const markPaid = () => action("paid", async () => {
    await fetch(`${API}/billing/invoices/${inv.id}`, {
      method: "PATCH", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: "paid", paidDate: new Date().toISOString().slice(0,10) }),
    });
    onMsg("Marked as paid.");
  });

  const openPdf = () => window.open(`${API}/billing/pdf/${inv.id}`, "_blank");

  return (
    <tr>
      <td>
        <div className="client-name">{inv.client}</div>
        <div className="client-email">{inv.email}</div>
      </td>
      <td><span style={{ fontSize: "0.8rem" }}>{inv.publication}</span></td>
      <td><span style={{ fontSize: "0.8rem" }}>{inv.type}</span></td>
      <td style={{ fontSize: "0.78rem", color: "var(--muted)" }}>
        {runDates.length ? runDates.map(fmtDate).join(", ") : "â€”"}
      </td>
      <td className="amount">{fmt$(inv.amount)}</td>
      <td><StatusBadge status={inv.status} /></td>
      <td>
        <div className="action-row">
          <button className="btn-ghost btn-sm" onClick={() => onEdit(inv)} title="Edit">âœŽ</button>
          <button className="btn-ghost btn-sm" onClick={openPdf} title="Print/PDF">âŽ™</button>
          <button className="btn-ghost btn-sm" disabled={busy === "email"}
            onClick={sendEmail} title="Send email">
            {busy === "email" ? <span className="spinner">âŸ³</span> : "âœ‰"}
          </button>
          <button className="btn-ghost btn-sm" disabled={busy === "stripe"}
            onClick={getStripeLink} title="Stripe payment link">
            {busy === "stripe" ? <span className="spinner">âŸ³</span> : "ðŸ’³"}
          </button>
          {inv.status !== "paid" && (
            <button className="btn-ghost btn-sm" disabled={busy === "paid"}
              onClick={markPaid} title="Mark paid" style={{ color: "var(--green)" }}>
              {busy === "paid" ? <span className="spinner">âŸ³</span> : "âœ“"}
            </button>
          )}
        </div>
      </td>
    </tr>
  );
}

// â”€â”€ Main app â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function InvoiceApp() {
  const [invoices, setInvoices] = useState([]);
  const [filter, setFilter]     = useState("all");
  const [search, setSearch]     = useState("");
  const [loading, setLoading]   = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [editInv, setEditInv]   = useState(null);
  const [msg, setMsg]           = useState("");

  const load = useCallback(async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      if (filter !== "all") params.set("status", filter);
      if (search) params.set("q", search);
      const r = await fetch(`${API}/billing/invoices?${params}`);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const d = await r.json();
      setInvoices(d.invoices || []);
    } catch (e) {
      setMsg(`Load error: ${e.message}`);
    } finally {
      setLoading(false);
    }
  }, [filter, search]);

  useEffect(() => { load(); }, [load]);

  // Sidebar counts â€” load all unfiltered for counts
  const [counts, setCounts] = useState({ all: 0, draft: 0, sent: 0, paid: 0 });
  useEffect(() => {
    fetch(`${API}/billing/invoices`).then(r => r.json()).then(d => {
      const all = d.invoices || [];
      setCounts({
        all:   all.length,
        draft: all.filter(i => i.status === "draft").length,
        sent:  all.filter(i => i.status === "sent").length,
        paid:  all.filter(i => i.status === "paid").length,
      });
    }).catch(() => {});
  }, [invoices]);

  const openNew  = () => { setEditInv(null); setShowForm(true); };
  const openEdit = (inv) => { setEditInv(inv); setShowForm(true); };
  const onSave   = () => { setShowForm(false); load(); };
  const flash    = (m) => { setMsg(m); setTimeout(() => setMsg(""), 4000); };

  return (
    <div className="app">
      <div className="masthead">
        <div>
          <div className="masthead-logo">Weekly Register-Call</div>
          <div className="masthead-sub">Ad Invoicing Â· Bookkeeper Dashboard</div>
        </div>
        <div className="masthead-right">
          <span style={{ fontSize: "0.8rem", color: "var(--muted)" }}>5280.menu</span>
        </div>
      </div>

      <div className="main">
        <Sidebar filter={filter} setFilter={v => { setFilter(v); }}
          counts={counts} onNew={openNew} />

        <div className="content">
          {msg && <div className="msg-bar">{msg}</div>}

          <div className="toolbar">
            <input className="search-input" type="text"
              placeholder="Search client, email, descriptionâ€¦"
              value={search} onChange={e => setSearch(e.target.value)} />
            <button className="btn-ghost" onClick={load}>â†º Refresh</button>
          </div>

          {loading ? (
            <p style={{ color: "var(--muted)", fontStyle: "italic" }}>Loadingâ€¦</p>
          ) : (
            <table className="invoice-table">
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Publication</th>
                  <th>Type</th>
                  <th>Run Dates</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {invoices.length === 0 ? (
                  <tr className="empty-row">
                    <td colSpan={7}>No invoices found. Click <strong>+ New Invoice</strong> to create one.</td>
                  </tr>
                ) : invoices.map(inv => (
                  <InvoiceRow key={inv.id} inv={inv} onEdit={openEdit}
                    onRefresh={load} onMsg={flash} />
                ))}
              </tbody>
            </table>
          )}
        </div>
      </div>

      {showForm && (
        <InvoiceDrawer inv={editInv} onSave={onSave} onClose={() => setShowForm(false)} />
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<InvoiceApp />);
</script>
</body>
</html>
